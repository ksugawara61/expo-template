name: VRT Pages Management
on:
  pull_request:
    types: [closed]
  schedule:
    # Run daily at midnight UTC to clean up old reports
    - cron: '0 0 * * *'
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  manage-pages:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' || (github.event_name == 'pull_request' && github.event.action == 'closed')
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: gh-pages
          fetch-depth: 0

      - name: Clean up closed PR reports
        if: github.event_name == 'pull_request' && github.event.action == 'closed'
        run: |
          if [ -d "pr-${{ github.event.pull_request.number }}" ]; then
            rm -rf "pr-${{ github.event.pull_request.number }}"
            echo "Removed VRT report for closed PR #${{ github.event.pull_request.number }}"
          fi

      - name: Clean up old reports (older than 30 days)
        if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        run: |
          # Find and remove directories older than 30 days
          find . -maxdepth 1 -type d -name "pr-*" -mtime +30 -exec rm -rf {} \;
          echo "Cleaned up reports older than 30 days"

      - name: Update index page
        run: |
          # Get all PR directories
          pr_dirs=$(find . -maxdepth 1 -type d -name "pr-*" | sort -V)

          cat > index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <title>VRT Reports</title>
            <meta charset="UTF-8">
            <style>
              body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                margin: 40px auto;
                max-width: 800px;
                line-height: 1.6;
                color: #333;
              }
              h1 { color: #0366d6; margin-bottom: 10px; }
              .subtitle { color: #666; margin-bottom: 30px; }
              ul { list-style-type: none; padding: 0; }
              li {
                margin: 15px 0;
                padding: 15px;
                border: 1px solid #e1e4e8;
                border-radius: 6px;
                background: #f6f8fa;
              }
              a {
                color: #0366d6;
                text-decoration: none;
                font-weight: 500;
              }
              a:hover { text-decoration: underline; }
              .empty {
                text-align: center;
                color: #666;
                font-style: italic;
                padding: 40px;
              }
              .footer {
                margin-top: 40px;
                padding-top: 20px;
                border-top: 1px solid #e1e4e8;
                color: #666;
                font-size: 14px;
                text-align: center;
              }
            </style>
          </head>
          <body>
            <h1>📊 VRT Reports</h1>
            <p class="subtitle">Visual Regression Test reports by Pull Request</p>
          EOF

          if [ -z "$pr_dirs" ]; then
            cat >> index.html << 'EOF'
            <div class="empty">現在利用可能なVRTレポートはありません</div>
          EOF
          else
            echo "<ul>" >> index.html
            for dir in $pr_dirs; do
              pr_num=$(basename "$dir" | sed 's/pr-//')
              echo "<li><a href=\"$dir/\">PR #$pr_num のVRTレポート</a></li>" >> index.html
            done
            echo "</ul>" >> index.html
          fi

          cat >> index.html << 'EOF'
            <div class="footer">
              <p>このページは自動生成されます。レポートは30日後に自動削除されます。</p>
            </div>
          </body>
          </html>
          EOF

      - name: Commit and push changes
        if: github.event_name == 'pull_request' || github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          if git diff --quiet && git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git add .
            git commit -m "Update VRT reports index page" || true
            git push origin gh-pages || true
          fi